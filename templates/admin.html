<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Panel de Administraci√≥n - Chatbot UTMACH</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .panel { background-color: #003366; color: white; padding: 20px; border-radius: 10px; }
        .preview { background-color: #e9ecef; padding: 20px; border-radius: 10px; min-height: 200px; }
        .btn-primary { background-color: #005bac; border-color: #004a94; }
        .btn-primary:hover { background-color: #004a94; }
        h3, h4, h5 { color: #003366; }
        .file-list a { color: #003366; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><img src="https://upload.wikimedia.org/wikipedia/commons/2/2c/Escudo_UTMACH.png" width="40"> PANEL DE ADMINISTRACI√ìN DE ARCHIVOS Y ENTRENAMIENTO - Chatbot UTMACH</h3>
            <a href="/monitor" class="btn btn-primary">‚Üê Volver al panel</a>
        </div>

        <div class="row">
            <!-- Subir documento -->
            <div class="col-md-4 panel">
                <h5>üìÅ Subir Documento PDF</h5>
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <input type="file" class="form-control-file" name="archivo" id="archivo" required />
                    </div>
                    <button type="submit" class="btn btn-light">üì• Subir Documento</button>
                </form>
                <div id="mensaje-subida" class="mt-2"></div>

                <hr>
                <h5>üìÇ Archivos Subidos</h5>
                <div id="archivos-subidos" class="mt-2"></div>
            </div>

            <!-- Vista previa -->
            <div class="col-md-8 preview">
                <h5>üßæ Vista Previa del PDF</h5>
                <div id="vista-previa">
                    <p>No hay archivos seleccionados</p>
                </div>
            </div>
        </div>

        <hr>
        <h4 class="text-center mt-4">Monitor de Pinecone</h4>
        <div class="text-center">
            <p id="estado-pinecone" class="text-danger">Cargando estado...</p>
        </div>
    </div>

    <script>
        document.getElementById("upload-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const formData = new FormData();
            const archivoInput = document.getElementById("archivo");
            formData.append("archivo", archivoInput.files[0]);

            try {
                const res = await fetch("/upload", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                document.getElementById("mensaje-subida").innerHTML = `<span class='text-success'>${data.message || data.error}</span>`;
                cargarArchivosSubidos();
            } catch (err) {
                document.getElementById("mensaje-subida").innerHTML = `<span class='text-danger'>Error al subir</span>`;
            }
        });

        async function cargarArchivosSubidos() {
            try {
                const res = await fetch('/list_files');
                const data = await res.json();

                if (data.files && data.files.length > 0) {
                    let html = "<ul class='file-list'>";
                    for (const archivo of data.files) {
                        html += `<li><a href="#" onclick="entrenarArchivo('${archivo}')">${archivo}</a> <button onclick="entrenarArchivo('${archivo}')" class="btn btn-sm btn-success ml-2">Entrenar</button></li>`;
                    }
                    html += "</ul>";
                    document.getElementById("archivos-subidos").innerHTML = html;
                } else {
                    document.getElementById("archivos-subidos").innerHTML = "<p>No hay archivos a√∫n.</p>";
                }
            } catch (err) {
                document.getElementById("archivos-subidos").innerHTML = "<p style='color:red;'>Error al obtener archivos</p>";
            }
        }

        async function entrenarArchivo(nombreArchivo) {
            const confirmacion = confirm(`¬øDeseas entrenar el archivo: ${nombreArchivo}?`);
            if (!confirmacion) return;

            try {
                const res = await fetch('/entrenar_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nombreArchivo })
                });
                const data = await res.json();
                alert(data.message || data.error);
            } catch (err) {
                alert("‚ùå Error al entrenar archivo.");
            }
        }

        async function obtenerEstadoPinecone() {
            try {
                const res = await fetch('/monitorear_pinecone');
                const json = await res.json();
                document.getElementById("estado-pinecone").innerText = `Vectores: ${json.data.total_vectors}, Uso: ${json.data.index_fullness_percentage.toFixed(2)}%`;
            } catch (err) {
                document.getElementById("estado-pinecone").innerText = "‚ùå Error al obtener estado.";
            }
        }

        cargarArchivosSubidos();
        obtenerEstadoPinecone();
    </script>
</body>
</html>>